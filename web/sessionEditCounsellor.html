<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counselor - Manage Sessions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            background-color: #f8f7fc;
            color: #333;
            min-height: 100vh;
        }

        /* ===== SIDEBAR (MODIFIED FROM CancelAppointmentCounsellor) ===== */
        .sidebar {
            width: 280px;
            background: #51245C;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(203, 149, 232, 0.2);
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .user-info {
            padding: 15px 0;
        }
        
        .user-info p {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.3em;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
        }
        
        .user-info small {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #a56cd1 0%, #8a4ec7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            font-size: 2.2em;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        /* Sidebar Menu */
        .sidebar-menu {
            list-style: none;
            padding: 25px 0;
        }
        
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 16px 30px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-size: 1.1em;
        }
        
        /* Menu icons */
        .sidebar-menu li a i {
            margin-right: 15px;
            font-size: 1.3em;
            width: 24px;
            text-align: center;
            color: white;
            opacity: 0.95;
        }

        .sidebar-menu li.active a {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-left-color: #FFB347;
            font-weight: 500;
        }

        .sidebar-menu li a:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding-left: 35px;
        }
        
        /* Logout Item */
        .sidebar-menu li.logout {
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 20px;
        }

        /* ===== MAIN CONTENT (MODIFIED) ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px 40px;
            min-height: 100vh;
        }

        /* Main Header (MODIFIED FROM CancelAppointmentCounsellor) */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 2px solid #e6e1f7;
        }

        .main-header h1 {
            color: #5D2E8C;
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: #8B7BA6;
            font-size: 1.1em;
            font-weight: 400;
        }

        .header-date {
            background: linear-gradient(135deg, #CB95E8 0%, #A56CD1 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95em;
            box-shadow: 0 4px 12px rgba(203, 149, 232, 0.3);
        }
        
        /* ===== NOTIFICATIONS (UNCHANGED) ===== */
        .notification {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
            border-left: 4px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .notification.success {
            background-color: #e8f6ef;
            color: #155724;
            border-left-color: #28a745;
        }

        .notification.error {
            background-color: #fdecea;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .notification.info {
            background-color: #e8f4fc;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .notification.warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        /* ===== CONTENT SECTION (Box Container) (UNCHANGED) ===== */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(203, 149, 232, 0.15);
        }

        /* ===== DATE & FORM AREA (UNCHANGED) ===== */
        .date-form-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 30px;
            margin-bottom: 30px;
            border-bottom: 1px solid #f0ebfa;
            padding-bottom: 20px;
        }

        .date-selector {
            flex-shrink: 0;
        }

        .date-input {
            padding: 12px 15px;
            border: 1px solid #e6e1f7;
            border-radius: 8px;
            font-size: 1.1em;
            width: 250px;
            background-color: #fcfbff;
            display: block;
            margin-top: 10px;
        }

        #currentDateDisplay {
            color: #5D2E8C;
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }
        
        /* Add Session Button */
        .add-session-btn {
            background: linear-gradient(135deg, #A56CD1 0%, #8a4ec7 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .add-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(165, 108, 209, 0.4);
        }

        /* Custom Session Form */
        #sessionFormContainer {
            flex-grow: 1;
            padding: 20px;
            border: 1px dashed #e6e1f7;
            border-radius: 10px;
            display: none; /* Hide initially */
            background-color: #fcfbff;
        }
        
        #sessionFormContainer h4 {
            margin-top: 0;
            color: #5D2E8C;
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #5D2E8C;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-control {
            padding: 10px;
            border: 1px solid #e6e1f7;
            border-radius: 8px;
            width: 100%;
        }

        .create-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            float: right;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: #f8f7fc;
            color: #8B7BA6;
            border: 1px solid #e6e1f7;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            float: right;
            margin-right: 10px;
            transition: all 0.3s;
        }


        /* ===== SESSIONS LIST (Unified Display) (UNCHANGED) ===== */
        .sessions-list-header {
            margin-top: 20px;
            margin-bottom: 20px;
            color: #5D2E8C;
            font-size: 1.4em;
            font-weight: 600;
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .session-slot {
            border: 1px solid #e6e1f7;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #fcfbff;
            transition: transform 0.2s ease;
        }
        
        .session-slot:hover {
            box-shadow: 0 4px 15px rgba(203, 149, 232, 0.2);
        }
        
        .slot-time {
            font-size: 1.2em;
            font-weight: 600;
            color: #5D2E8C;
        }
        
        .slot-description {
            font-size: 0.9em;
            color: #8B7BA6;
            margin-bottom: 10px;
        }
        
        /* Status styling */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-available {
            background-color: #e8f6ef;
            color: #155724;
        }
        
        .status-booked {
            background-color: #fdecea;
            color: #721c24;
        }
        
        .status-past {
            background-color: #e6e1f7;
            color: #8B7BA6;
        }

        /* ===== SUCCESS POPUP STYLES (UNCHANGED) ===== */
        .success-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 2000;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .success-popup-modal {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            margin-right: 15px;
            width: 90%;
            max-width: 280px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
        }
        
        .success-popup-modal.error-style { border-left: 5px solid #dc3545; }
        .success-popup-modal.success-style { border-left: 5px solid #28a745; }

        .success-popup-modal.show {
            animation: slideInRight 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .success-popup-modal .icon.success-icon { font-size: 2em; color: #28a745; margin-bottom: 8px; }
        .success-popup-modal .icon.error-icon { font-size: 2em; color: #dc3545; margin-bottom: 8px; }

        .success-popup-modal p { 
            font-size: 1em; 
            font-weight: 600; 
            color: #333; 
            margin: 0; 
        }
        
        /* Responsive tweaks (UNCHANGED) */
        @media (max-width: 768px) {
            .main-content { margin-left: 0; padding: 20px; }
            .date-form-container { flex-direction: column; }
            .date-selector { width: 100%; margin-bottom: 20px; }
            .date-input { width: 100%; }
            .sessions-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            
            .success-popup-overlay {
                justify-content: center;
                align-items: flex-end;
            }
            .success-popup-modal {
                margin-bottom: 20px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="user-info">
                <div class="avatar">CD</div>
                <p>Counselor Dashboard</p>
                <small>Staff ID: CNSL2023001</small>
                <small>Role: Senior Counselor</small>
            </div>
        </div>
        
        <ul class="sidebar-menu">
            <li><a href="counselorDashboard.html"><i class="fas fa-chart-bar"></i> Dashboard</a></li>
            <!--<li><a href="book-appointment.html"><i class="far fa-calendar-plus"></i> Book Appointment</a></li>-->
            <li><a href="cAappointment.html"><i class="far fa-calendar-alt"></i> Manage Appointments</a></li>
            <!--<li><a href="cancel-appointment.html"><i class="fas fa-calendar-times"></i> Cancel Appointment</a></li>-->
            <li class="active"><a href="#"><i class="fas fa-tasks"></i> Manage Sessions</a></li>
            <!--<li><a href="student-records.html"><i class="fas fa-users"></i> Student Records</a></li>-->
            <!--<li><a href="reports.html"><i class="fas fa-chart-pie"></i> Reports</a></li>-->
            <li class="logout"><a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="main-header">
            <div>
                <h1>Manage Counseling Sessions</h1>
                <p class="welcome-subtitle">Create, manage, and view available session slots.</p>
            </div>
            <div class="header-date" id="currentDate"></div>
        </div>
        
        <div id="notification" class="notification"></div>

        <div class="content-section">
            
            <div class="date-form-container">
                
                <div class="date-selector">
                    <label for="sessionDate"><h4><i class="fas fa-calendar-day"></i> Select Session Date</h4></label>
                    <input type="date" class="date-input" id="sessionDate" onchange="loadAvailableSessions(this.value)">
                    <span id="currentDateDisplay"></span>
                    
                    <button class="add-session-btn" style="margin-top: 20px;" onclick="toggleSessionForm(true)">
                        <i class="fas fa-plus-circle"></i> Add New Session
                    </button>
                </div>
                
                <div id="sessionFormContainer">
                    <h4><i class="fas fa-plus"></i> Set Session Time</h4>
                    <form onsubmit="event.preventDefault(); createNewSession();">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeStart">Start Time (24H)</label>
                                <input type="time" class="form-control" id="timeStart" required step="3600">
                            </div>
                            <div class="form-group">
                                <label for="timeEnd">End Time (24H)</label>
                                <input type="time" class="form-control" id="timeEnd" required step="3600">
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="hidden" id="sessionDescription" value="Counselling Session">
                        </div>
                        <button type="submit" class="create-btn">
                            <i class="fas fa-calendar-check"></i> Confirm & Create Session
                        </button>
                        <button type="button" class="cancel-btn" onclick="toggleSessionForm(false)">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </form>
                </div>
            </div>
            
            <h3 class="sessions-list-header"><i class="fas fa-list-alt"></i> Existing Sessions on This Date</h3>
            
            <div class="sessions-grid" id="availableSessionsGrid">
                <p style="grid-column: 1 / -1; text-align: center; color: #8B7BA6; padding: 20px;">Loading sessions...</p>
            </div>

        </div>
    </div>

    <div class="success-popup-overlay" id="successPopupOverlay">
        <div class="success-popup-modal" id="successPopupModal">
            <div class="icon" id="popupIcon"></div>
            <p id="successMessage">Notification Message</p>
        </div>
    </div>


    <script>
        // Definisi 6 slot standard mengikut permintaan anda (09:00, 10:00, 11:00, 14:00, 16:00, 18:00)
        const standardSlots = [
            { startTime: "09:00", endTime: "10:00", duration: "1 hour", defaultDescription: "Counselling Session" },
            { startTime: "10:00", endTime: "11:00", duration: "1 hour", defaultDescription: "1 hour" },
            { startTime: "11:00", endTime: "12:00", duration: "1 hour", defaultDescription: "Standard Academic Session" },
            { startTime: "14:00", endTime: "15:00", duration: "1 hour", defaultDescription: "1 hour" },
            { startTime: "16:00", endTime: "17:00", duration: "1 hour", defaultDescription: "1 hour" },
            { startTime: "18:00", endTime: "19:00", duration: "1 hour", defaultDescription: "1 hour" },
        ];
        
        // --- DATA SIMULATION ---
        const TODAY = new Date();
        const NEXT_DATE_OBJ = new Date(TODAY);
        NEXT_DATE_OBJ.setDate(TODAY.getDate() + 1);
        const DEFAULT_DATE_DEMO = formatDate(NEXT_DATE_OBJ); // Tomorrow's date
        
        // Log ini menjejak semua sesi yang telah ditempah atau ditambah (Custom)
        let globalSessionLog = [
            // Slot BOOKED yang bertindih dengan standard 16:00
            { id: 1001, date: DEFAULT_DATE_DEMO, startTime: "16:00", endTime: "17:00", description: "Student Appointment (Booked)", isBooked: true, isCustom: false },
            
            // Slot Custom AVAILABLE (bukan slot standard)
            { id: 1002, date: DEFAULT_DATE_DEMO, startTime: "12:30", endTime: "13:30", description: "Brief Extra Slot (Custom)", isBooked: false, isCustom: true },

            // Slot Custom yang bertindih dengan slot standard pada tarikh lain (untuk ujian)
            { id: 2001, date: formatDate(new Date(TODAY.getTime() + (2 * 24 * 60 * 60 * 1000))), startTime: "09:00", endTime: "10:00", description: "Standard Academic Session (Booked)", isBooked: true, isCustom: false },
        ];
        
        // --- DOM ELEMENTS ---
        const sessionDateInput = document.getElementById('sessionDate');
        const availableSessionsGrid = document.getElementById('availableSessionsGrid');
        const notification = document.getElementById('notification');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const sessionFormContainer = document.getElementById('sessionFormContainer');

        // Form Inputs
        const timeStartInput = document.getElementById('timeStart');
        const timeEndInput = document.getElementById('timeEnd');
        const sessionDescriptionInput = document.getElementById('sessionDescription');

        // --- HELPER FUNCTIONS ---
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDisplayDate(dateString) {
            // Use replace for safer date parsing across browsers
            const dateObj = new Date(dateString.replace(/-/g, '/')); 
            if (dateObj.getHours() === 0 && dateObj.getMinutes() === 0) {
                 dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return dateObj.toLocaleDateString('en-US', options);
        }

        // Check for time overlap in the global log AND against standard slots
        function isTimeOverlap(date, startTime, endTime) {
            
            // 1. Kumpulkan SEMUA sesi yang sedia ada pada tarikh ini:
            let allExistingSlots = globalSessionLog.filter(session => session.date === date);

            // 2. Tambah SEMUA slot standard yang TIADA dalam global log (available slots)
            standardSlots.forEach(standard => {
                const isLogged = allExistingSlots.some(logEntry => 
                    logEntry.startTime === standard.startTime && logEntry.endTime === standard.endTime
                );
                
                // Penting: Hanya tambahkan slot standard jika ia *belum* ada dalam log sebagai booked/custom.
                if (!isLogged) {
                    allExistingSlots.push({
                         date: date, startTime: standard.startTime, endTime: standard.endTime, description: standard.duration, isBooked: false, isCustom: false
                    });
                }
            });

            // 3. Semak pertindihan terhadap semua slot sedia ada
             const overlappingSession = allExistingSlots.find(session => {
                const existingStart = session.startTime;
                const existingEnd = session.endTime;
                
                // Overlap logic: New session starts before existing ends AND New session ends after existing starts
                return (startTime < existingEnd && endTime > existingStart);
            });
            
            return overlappingSession !== undefined;
        }

        // --- UI TOGGLE ---
        function toggleSessionForm(show) {
            sessionFormContainer.style.display = show ? 'flex' : 'none';
            if (show) {
                 // Reset form fields
                 document.querySelector('#sessionFormContainer form').reset();
                 
                 // SET DEFAULT TIME TO HH:00 AND NEXT HOUR
                 const now = new Date();
                 let hour = now.getHours();
                 
                 // Default to 9 AM if outside typical working hours
                 if (hour >= 18 || hour < 9) { 
                     hour = 9; 
                 } else {
                     hour = hour + 1;
                 }
                 
                 const defaultStart = String(hour).padStart(2, '0') + ":00";
                 const defaultEnd = String(hour + 1).padStart(2, '0') + ":00";
                 
                 timeStartInput.value = defaultStart; 
                 timeEndInput.value = defaultEnd;
                 
                 sessionFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- CORE FUNCTION 1: Load/Display All Sessions for Selected Date ---
        function loadAvailableSessions(selectedDate) {
            if (!selectedDate) return;
            
            // Set current date in header for display purposes
            currentDateDisplay.textContent = formatDisplayDate(selectedDate);
            
            let sessionsToDisplay = [];
            const sessionsForDate = globalSessionLog.filter(s => s.date === selectedDate);
            
            // 1. Ulangan 6 Slot Standard + status override (BOOKED/CUSTOM)
            standardSlots.forEach(standard => {
                const existingLogEntry = sessionsForDate.find(s => 
                    s.startTime === standard.startTime && 
                    s.endTime === standard.endTime
                );
                
                let session;
                
                if (existingLogEntry) {
                    // Gunakan data log jika ada (kerana statusnya mungkin BOOKED atau Custom yang bertindih)
                    session = existingLogEntry;
                } else {
                    // Jika tiada log, slot ini adalah AVAILABLE Standard
                    session = { 
                        date: selectedDate, 
                        startTime: standard.startTime, 
                        endTime: standard.endTime, 
                        description: standard.defaultDescription, 
                        isBooked: false,
                        isCustom: false
                    };
                }
                
                sessionsToDisplay.push(session);
            });

            // 2. Tambah Slot Custom yang bukan Standard (dicantumkan dalam paparan)
            const pureCustomSessions = sessionsForDate.filter(s => 
                s.isCustom && 
                !standardSlots.some(standard => standard.startTime === s.startTime && standard.endTime === s.endTime)
            );
            
            sessionsToDisplay.push(...pureCustomSessions);

            // 3. Sort by start time 
            sessionsToDisplay.sort((a, b) => {
                if (a.startTime > b.startTime) return 1;
                if (a.startTime < b.startTime) return -1;
                return 0;
            });

            // 4. Render ke grid
            if (sessionsToDisplay.length === 0) {
                availableSessionsGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #8B7BA6; padding: 20px;">No standard sessions found for this date. Please select a different date.</p>`;
                return;
            }

            let htmlContent = '';
            const now = new Date();
            const todayDate = formatDate(now);
            
            sessionsToDisplay.forEach(session => {
                let statusText;
                let statusClass;
                
                // Calculate duration for display (based on start/end time)
                const start = session.startTime.split(':').map(Number);
                const end = session.endTime.split(':').map(Number);
                const totalMinutes = (end[0] * 60 + end[1]) - (start[0] * 60 + start[1]);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                let durationDisplay = '';

                if (hours > 0) durationDisplay += `${hours} hour${hours !== 1 ? 's' : ''}`;
                if (minutes > 0) durationDisplay += `${hours > 0 ? ' and ' : ''}${minutes} minute${minutes !== 1 ? 's' : ''}`;
                if (totalMinutes === 0) durationDisplay = '0 minutes';
                
                // Check if session has passed
                const sessionEndDateTime = new Date(`${session.date.replace(/-/g, '/')}T${session.endTime}:00`); 
                const isPast = (session.date < todayDate) || (session.date === todayDate && sessionEndDateTime < now);
                
                if (isPast) {
                    statusText = 'PAST';
                    statusClass = 'past';
                } else if (session.isBooked) {
                    statusText = 'BOOKED';
                    statusClass = 'booked';
                } else {
                    // ALL available slots (standard or custom) are marked as AVAILABLE
                    statusText = 'AVAILABLE';
                    statusClass = 'available';
                }

                htmlContent += `
                    <div class="session-slot">
                        <div class="slot-time">${session.startTime} - ${session.endTime}</div>
                        <div class="slot-description">${durationDisplay}</div>
                        <div class="status-badge status-${statusClass}">${statusText}</div>
                    </div>
                `;
            });
            
            availableSessionsGrid.innerHTML = htmlContent;
        }
        
        // --- CORE FUNCTION 2: Create New Session (Adding Custom Slot) ---
        function createNewSession() {
            const date = sessionDateInput.value; 
            const startTime = timeStartInput.value;
            const endTime = timeEndInput.value;
            const description = sessionDescriptionInput.value || "New Counselling Slot"; 

            if (!date || !startTime || !endTime) {
                showSuccessPopup('Please fill in both Start Time and End Time.', 'error');
                return;
            }
            
            // Validation 1: Ensure Start Time is before End Time
            if (startTime >= endTime) {
                 showSuccessPopup('Error: Start time must be earlier than end time.', 'error');
                 return;
            }
            
            // **VALIDATION 2: CHECK FOR OVERLAP AGAINST EXISTING SESSIONS (CRITICAL)**
            if (isTimeOverlap(date, startTime, endTime)) {
                 // Mesej ralat spesifik seperti yang diminta
                 showSuccessPopup('Error: The chosen date and time conflict with an existing session. Please select a different time.', 'error');
                 return;
            }
            
            // Validation 3: Ensure session is not in the past
            const now = new Date();
            const sessionStartDateTime = new Date(`${date.replace(/-/g, '/')}T${startTime}:00`);
            if (sessionStartDateTime < now) {
                 showSuccessPopup('Error: You cannot add a session for a time that has already passed.', 'error');
                 return;
            }

            // Generate a unique ID
            const newId = globalSessionLog.length > 0 ? Math.max(...globalSessionLog.map(s => s.id)) + 1 : 1;

            // Create new session object
            const newSession = {
                id: newId, 
                date: date,
                startTime: startTime,
                endTime: endTime,
                description: description,
                isBooked: false, 
                isCustom: true // Mark as custom created slot
            };

            // Add to the global log (simulating saving to database)
            globalSessionLog.push(newSession);

            // Clear form and hide it
            document.querySelector('#sessionFormContainer form').reset();
            toggleSessionForm(false);
            
            // Show success popup
            showSuccessPopup('New session successfully added!', 'success');

            // --- IMMEDIATE UPDATE: Refresh the grid ---
            loadAvailableSessions(date);
        }

        // --- UTILITY/NOTIFICATION FUNCTIONS (UNCHANGED) ---
        
        function showNotification(message, type) {
            const notificationBar = document.getElementById('notification');
            notificationBar.innerHTML = message;
            notificationBar.className = `notification ${type}`;
            notificationBar.style.display = 'block';
            
            setTimeout(() => {
                notificationBar.style.display = 'none';
            }, 5000);
        }

        // Modified showSuccessPopup to handle both success (green, smaller) and error (red, smaller)
        function showSuccessPopup(message, type = 'success') {
            const successPopupOverlay = document.getElementById('successPopupOverlay');
            const successPopupModal = document.getElementById('successPopupModal');
            const popupIcon = document.getElementById('popupIcon');
            const successMessage = document.getElementById('successMessage');
            
            // Reset state
            successPopupModal.classList.remove('error-style', 'success-style', 'show');
            
            // Set style based on type
            if (type === 'error') {
                successPopupModal.classList.add('error-style');
                popupIcon.className = 'icon error-icon fas fa-exclamation-triangle';
                successMessage.style.color = '#721c24'; // Red text
            } else {
                // SUCCESS (Green) Style
                successPopupModal.classList.add('success-style');
                popupIcon.className = 'icon success-icon fas fa-check-circle';
                successMessage.style.color = '#155724'; // Green text
            }
            
            successMessage.innerHTML = message;
            
            successPopupOverlay.style.display = 'flex';
            successPopupModal.classList.add('show');
            
            setTimeout(() => {
                successPopupModal.classList.remove('show');
                successPopupModal.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    successPopupOverlay.style.display = 'none';
                    successPopupModal.style.transform = 'translateX(0)';
                    successMessage.style.color = '#333';
                }, 400); 
            }, 3000); 
        }
        
        // --- INITIALIZATION SCRIPT (MODIFIED) ---
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const todayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            // Set current date in header
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', todayOptions);

            sessionDateInput.min = formatDate(today);
            
            // Set default date to the next date of current date (Tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const defaultLoadDate = formatDate(tomorrow);
            
            sessionDateInput.value = defaultLoadDate;

            // Load sessions for the default date
            loadAvailableSessions(defaultLoadDate);
        });

    </script>
</body>
</html>